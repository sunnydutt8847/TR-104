// utils/razorpay.js
const Razorpay = require('razorpay');
const crypto = require('crypto');

const razorpay = new Razorpay({
  key_id: process.env.RAZORPAY_KEY_ID,
  key_secret: process.env.RAZORPAY_KEY_SECRET
});

exports.createOrder = async (amount, currency = 'INR', receipt) => {
  try {
    const options = {
      amount: amount * 100, // amount in paise
      currency,
      receipt,
      payment_capture: 1
    };
    
    const order = await razorpay.orders.create(options);
    return order;
  } catch (error) {
    throw new Error(`Razorpay order creation failed: ${error.message}`);
  }
};

exports.verifyPayment = (razorpay_order_id, razorpay_payment_id, razorpay_signature) => {
  const body = razorpay_order_id + "|" + razorpay_payment_id;
  const expectedSignature = crypto
    .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
    .update(body.toString())
    .digest('hex');
  
  return expectedSignature === razorpay_signature;
};

exports.getPaymentDetails = async (paymentId) => {
  try {
    return await razorpay.payments.fetch(paymentId);
  } catch (error) {
    throw new Error(`Failed to fetch payment: ${error.message}`);
  }
};

// routes/paymentRoutes.js
const express = require('express');
const router = express.Router();
const { createOrder, verifyPayment } = require('../utils/razorpay');
const Order = require('../models/Order');
const auth = require('../middleware/auth');

// Create payment order
router.post('/create-order', auth, async (req, res) => {
  try {
    const { orderId } = req.body;
    
    const order = await Order.findOne({ _id: orderId, user: req.user.id });
    if (!order) return res.status(404).json({ error: 'Order not found' });
    if (order.paymentStatus === 'Paid') {
      return res.status(400).json({ error: 'Order already paid' });
    }
    
    const razorpayOrder = await createOrder(
      order.finalAmount,
      'INR',
      `order_${order._id}`
    );
    
    res.json({
      order_id: razorpayOrder.id,
      amount: razorpayOrder.amount,
      currency: razorpayOrder.currency,
      key: process.env.RAZORPAY_KEY_ID
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Verify payment
router.post('/verify', auth, async (req, res) => {
  try {
    const { 
      razorpay_order_id, 
      razorpay_payment_id, 
      razorpay_signature,
      orderId 
    } = req.body;
    
    const isValid = verifyPayment(
      razorpay_order_id,
      razorpay_payment_id,
      razorpay_signature
    );
    
    if (!isValid) {
      return res.status(400).json({ error: 'Payment verification failed' });
    }
    
    // Update order payment status
    const order = await Order.findById(orderId);
    if (!order) return res.status(404).json({ error: 'Order not found' });
    
    order.paymentStatus = 'Paid';
    order.paymentDetails = {
      razorpay_order_id,
      razorpay_payment_id,
      razorpay_signature
    };
    
    await order.save();
    
    res.json({ 
      success: true, 
      message: 'Payment verified successfully',
      order 
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Webhook for payment notifications
router.post('/webhook', express.raw({ type: 'application/json' }), async (req, res) => {
  try {
    const signature = req.headers['x-razorpay-signature'];
    const webhookSecret = process.env.RAZORPAY_WEBHOOK_SECRET;
    
    const shasum = crypto.createHmac('sha256', webhookSecret);
    shasum.update(JSON.stringify(req.body));
    const digest = shasum.digest('hex');
    
    if (signature !== digest) {
      return res.status(400).json({ error: 'Invalid webhook signature' });
    }
    
    const event = req.body.event;
    const payment = req.body.payload.payment.entity;
    
    // Handle different payment events
    switch (event) {
      case 'payment.captured':
        // Update order as paid
        await handleSuccessfulPayment(payment);
        break;
      case 'payment.failed':
        // Update order as failed
        await handleFailedPayment(payment);
        break;
      // Add more cases as needed
    }
    
    res.json({ received: true });
  } catch (error) {
    console.error('Webhook error:', error);
    res.status(500).json({ error: error.message });
  }
});

async function handleSuccessfulPayment(payment) {
  // Extract order ID from notes or description
  const orderId = payment.notes?.order_id;
  if (orderId) {
    await Order.findByIdAndUpdate(orderId, {
      paymentStatus: 'Paid',
      paymentDetails: payment
    });
  }
}

async function handleFailedPayment(payment) {
  const orderId = payment.notes?.order_id;
  if (orderId) {
    await Order.findByIdAndUpdate(orderId, {
      paymentStatus: 'Failed',
      paymentDetails: payment
    });
  }
}

module.exports = router;

