Payment Integration (Stripe)

Today's Focus: Implementing Payment Processing
What I Learned: Secure payment handling with Stripe. Learned:

Stripe API integration

Payment intents

Checkout session

Webhook handling

Subscription management

Payment security best practices

Practice Example: Stripe Integration

const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

// Create payment intent
app.post('/api/create-payment-intent', async (req, res) => {
    try {
        const { amount, currency = 'usd' } = req.body;
        
        const paymentIntent = await stripe.paymentIntents.create({
            amount: amount * 100, // Convert to cents
            currency,
            metadata: {
                userId: req.user.id,
                orderId: req.body.orderId
            }
        });
        
        res.json({
            clientSecret: paymentIntent.client_secret
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Create checkout session
app.post('/api/create-checkout-session', async (req, res) => {
    try {
        const { items, successUrl, cancelUrl } = req.body;
        
        const session = await stripe.checkout.sessions.create({
            payment_method_types: ['card'],
            line_items: items.map(item => ({
                price_data: {
                    currency: 'usd',
                    product_data: {
                        name: item.name,
                        description: item.description,
                        images: [item.image]
                    },
                    unit_amount: item.price * 100
                },
                quantity: item.quantity
            })),
            mode: 'payment',
            success_url: `${process.env.CLIENT_URL}${successUrl}`,
            cancel_url: `${process.env.CLIENT_URL}${cancelUrl}`,
            customer_email: req.user.email,
            metadata: {
                userId: req.user.id
            }
        });
        
        res.json({ sessionId: session.id });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Handle webhook events
app.post('/api/webhook', express.raw({ type: 'application/json' }), (req, res) => {
    const sig = req.headers['stripe-signature'];
    let event;
    
    try {
        event = stripe.webhooks.constructEvent(
            req.body,
            sig,
            process.env.STRIPE_WEBHOOK_SECRET
        );
    } catch (error) {
        return res.status(400).send(`Webhook Error: ${error.message}`);
    }
    
    switch (event.type) {
        case 'payment_intent.succeeded':
            const paymentIntent = event.data.object;
            handleSuccessfulPayment(paymentIntent);
            break;
            
        case 'payment_intent.payment_failed':
            const failedPayment = event.data.object;
            handleFailedPayment(failedPayment);
            break;
            
        case 'checkout.session.completed':
            const session = event.data.object;
            handleCheckoutCompletion(session);
            break;
    }
    
    res.json({ received: true });
});

// Create subscription
app.post('/api/create-subscription', async (req, res) => {
    try {
        const { priceId, customerId } = req.body;
        
        const subscription = await stripe.subscriptions.create({
            customer: customerId,
            items: [{ price: priceId }],
            payment_behavior: 'default_incomplete',
            expand: ['latest_invoice.payment_intent']
        });
        
        res.json({
            subscriptionId: subscription.id,
            clientSecret: subscription.latest_invoice.payment_intent.client_secret
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

Practice Questions:

Implement one-time payment for products

Create subscription-based service

Add coupon/discount functionality

Build payment history and invoices
